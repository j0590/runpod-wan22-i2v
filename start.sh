#!/usr/bin/env bash
set -euo pipefail
ts(){ date +"[%H:%M:%S]"; }
log(){ echo "$(ts) $1"; }
export WORKSPACE=/workspace
export COMFY_DIR="${WORKSPACE}/ComfyUI"
export VENV_ROOT="${WORKSPACE}/venvs"
export CACHE_ROOT="${WORKSPACE}/cache"
export PIP_CACHE_DIR="${CACHE_ROOT}/pip"
export TORCHINDUCTOR_CACHE_DIR="${CACHE_ROOT}/torchinductor"
export TRITON_CACHE_DIR="${CACHE_ROOT}/triton"
export XDG_CACHE_HOME="${CACHE_ROOT}/xdg"
export GIT_TERMINAL_PROMPT="${GIT_TERMINAL_PROMPT:-0}"
export GIT_LFS_SKIP_SMUDGE=1
mkdir -p "${WORKSPACE}" "${VENV_ROOT}" "${CACHE_ROOT}" "${PIP_CACHE_DIR}" "${TORCHINDUCTOR_CACHE_DIR}" "${TRITON_CACHE_DIR}" "${XDG_CACHE_HOME}"
GPU_NAME="$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -n1 || true)"
PROFILE="py312-cuda128"
if echo "${GPU_NAME}" | grep -qi "5090"; then PROFILE="py312-5090"; fi
VENV_PATH="${VENV_ROOT}/${PROFILE}"
BOOT_SENTINEL="${WORKSPACE}/.bootstrap_done_${PROFILE}"
export COMFYUI_ARGS="${COMFYUI_ARGS:---listen 0.0.0.0 --port 8188}"
if echo " ${COMFYUI_ARGS} " | grep -q " -listen "; then COMFYUI_ARGS="$(echo " ${COMFYUI_ARGS} " | sed 's/ -listen / --listen /g' | xargs)"; fi
log "üöÄ Boot starting"
log "üß† GPU: ${GPU_NAME:-unknown}"
log "üß∞ Profile: ${PROFILE}"
if [ ! -d "${VENV_PATH}" ]; then log "üß™ Creating venv: ${VENV_PATH}"; python -m venv "${VENV_PATH}"; fi
source "${VENV_PATH}/bin/activate"
log "‚úÖ venv active"
if [ ! -f "${VENV_PATH}/.base_ready" ]; then log "üì¶ Installing base Python deps (one-time)"; pip install -U pip setuptools wheel packaging; pip install "numpy==1.26.4" "opencv-python==4.10.0.84" pyyaml gdown requests tqdm; pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0 --index-url https://download.pytorch.org/whl/cu128; pip freeze | grep -E "^(torch|torchvision|torchaudio)" > "${VENV_PATH}/torch-constraint.txt" || true; touch "${VENV_PATH}/.base_ready"; log "‚úÖ Base deps installed"; else log "‚úÖ Base deps already installed"; fi
mkdir -p "${COMFY_DIR}/custom_nodes" "${COMFY_DIR}/models/diffusion_models" "${COMFY_DIR}/models/clip" "${COMFY_DIR}/models/vae" "${COMFY_DIR}/models/loras" "${COMFY_DIR}/models/upscale_models" "${COMFY_DIR}/user/default/workflows"
if [ -f /moeksampler.json ]; then cp -f /moeksampler.json "${COMFY_DIR}/user/default/workflows/moeksampler.json"; log "‚úÖ Workflow installed: moeksampler.json"; fi
dl(){ url="$1"; out="$2"; if [ -f "$out" ]; then log "‚úÖ Model exists: $(basename "$out")"; else log "‚¨áÔ∏è Downloading: $(basename "$out")"; aria2c -x16 -s16 -k1M -o "$(basename "$out")" -d "$(dirname "$out")" "$url"; log "‚úÖ Downloaded: $(basename "$out")"; fi }
dltoken(){ url="$1"; out="$2"; token="$3"; if [ -f "$out" ]; then log "‚úÖ Model exists: $(basename "$out")"; else log "‚¨áÔ∏è Downloading: $(basename "$out")"; curl -L --fail --retry 10 --retry-delay 2 -H "Authorization: Bearer ${token}" "$url" -o "$out"; log "‚úÖ Downloaded: $(basename "$out")"; fi }
clone_one(){ repo="$1"; dir="$2"; name="$3"; if [ -d "${dir}/.git" ]; then echo "$(ts) ‚úÖ Node exists: ${name}"; return 0; fi; echo "$(ts) ‚¨áÔ∏è Cloning node: ${name}"; git clone --depth 1 --filter=blob:none --no-tags --single-branch "${repo}" "${dir}" >/dev/null 2>&1 && echo "$(ts) ‚úÖ Cloned: ${name}"; }
install_node_deps(){ dir="$1"; if [ -f "${dir}/.deps_ready" ]; then echo "$(ts) ‚úÖ Deps ok: $(basename "$dir")"; return 0; fi; if [ -f "${dir}/requirements.txt" ]; then echo "$(ts) üß© pip install: $(basename "$dir")"; pip install -r "${dir}/requirements.txt"; fi; if [ -f "${dir}/install.py" ]; then echo "$(ts) üß© install.py: $(basename "$dir")"; python "${dir}/install.py"; fi; touch "${dir}/.deps_ready"; echo "$(ts) ‚úÖ Node ready: $(basename "$dir")"; }
if [ ! -f "${BOOT_SENTINEL}" ]; then log "üß± Full bootstrap starting"; if [ ! -d "${COMFY_DIR}/.git" ]; then log "‚¨áÔ∏è Cloning ComfyUI"; git clone --depth 1 https://github.com/comfyanonymous/ComfyUI.git "${COMFY_DIR}"; log "‚úÖ ComfyUI cloned"; fi; if [ ! -f "${COMFY_DIR}/.req_ready" ]; then log "üì¶ Installing ComfyUI requirements"; pip install -r "${COMFY_DIR}/requirements.txt"; touch "${COMFY_DIR}/.req_ready"; log "‚úÖ ComfyUI requirements installed"; else log "‚úÖ ComfyUI requirements already done"; fi; cd "${COMFY_DIR}/custom_nodes"; repos=( "https://github.com/ssitu/ComfyUI_UltimateSDUpscale.git|ComfyUI_UltimateSDUpscale" "https://github.com/kijai/ComfyUI-KJNodes.git|ComfyUI-KJNodes" "https://github.com/rgthree/rgthree-comfy.git|rgthree-comfy" "https://github.com/JPS-GER/ComfyUI_JPS-Nodes.git|ComfyUI_JPS-Nodes" "https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes.git|ComfyUI_Comfyroll_CustomNodes" "https://github.com/Jordach/comfy-plasma.git|comfy-plasma" "https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git|ComfyUI-VideoHelperSuite" "https://github.com/bash-j/mikey_nodes.git|mikey_nodes" "https://github.com/ltdrdata/ComfyUI-Impact-Pack.git|ComfyUI-Impact-Pack" "https://github.com/Fannovel16/comfyui_controlnet_aux.git|comfyui_controlnet_aux" "https://github.com/yolain/ComfyUI-Easy-Use.git|ComfyUI-Easy-Use" "https://github.com/kijai/ComfyUI-Florence2.git|ComfyUI-Florence2" "https://github.com/ShmuelRonen/ComfyUI-LatentSyncWrapper.git|ComfyUI-LatentSyncWrapper" "https://github.com/WASasquatch/was-node-suite-comfyui.git|was-node-suite-comfyui" "https://github.com/theUpsider/ComfyUI-Logic.git|ComfyUI-Logic" "https://github.com/cubiq/ComfyUI_essentials.git|ComfyUI_essentials" "https://github.com/chrisgoringe/cg-image-picker.git|cg-image-picker" "https://github.com/chflame163/ComfyUI_LayerStyle.git|ComfyUI_LayerStyle" "https://github.com/chrisgoringe/cg-use-everywhere.git|cg-use-everywhere" "https://github.com/kijai/ComfyUI-segment-anything-2.git|ComfyUI-segment-anything-2" "https://github.com/ClownsharkBatwing/RES4LYF.git|RES4LYF" "https://github.com/welltop-cn/ComfyUI-TeaCache.git|ComfyUI-TeaCache" "https://github.com/Fannovel16/ComfyUI-Frame-Interpolation.git|ComfyUI-Frame-Interpolation" "https://github.com/Jonseed/ComfyUI-Detail-Daemon.git|ComfyUI-Detail-Daemon" "https://github.com/kijai/ComfyUI-WanVideoWrapper.git|ComfyUI-WanVideoWrapper" "https://github.com/chflame163/ComfyUI_LayerStyle_Advance.git|ComfyUI_LayerStyle_Advance" "https://github.com/BadCafeCode/masquerade-nodes-comfyui.git|masquerade-nodes-comfyui" "https://github.com/1038lab/ComfyUI-RMBG.git|ComfyUI-RMBG" "https://github.com/M1kep/ComfyLiterals.git|ComfyLiterals" "https://github.com/princepainter/ComfyUI-PainterI2V.git|ComfyUI-PainterI2V" "https://github.com/stduhpf/ComfyUI-WanMoeKSampler.git|ComfyUI-WanMoeKSampler" "https://github.com/Miosp/ComfyUI-FBCNN.git|ComfyUI-FBCNN" ); CLONE_JOBS="${CLONE_JOBS:-8}"; log "üß© Custom nodes setup (parallel clone: ${CLONE_JOBS} jobs)"; printf "%s\n" "${repos[@]}" | awk -F"|" '{print $1" "$2}' | xargs -P "${CLONE_JOBS}" -n 2 bash -lc 'clone_one "$0" "$1" "$1"' || true; for item in "${repos[@]}"; do url="${item%%|*}"; name="${item##*|}"; dir="$(basename "$url" .git)"; if [ -d "${dir}" ]; then install_node_deps "${COMFY_DIR}/custom_nodes/${dir}"; fi; done; dl "https://huggingface.co/FX-FeiHou/wan2.2-Remix/resolve/main/NSFW/Wan2.2_Remix_NSFW_i2v_14b_high_lighting_v2.0.safetensors" "${COMFY_DIR}/models/diffusion_models/Wan2.2_Remix_NSFW_i2v_14b_high_lighting_v2.0.safetensors"; dl "https://huggingface.co/FX-FeiHou/wan2.2-Remix/resolve/main/NSFW/Wan2.2_Remix_NSFW_i2v_14b_low_lighting_v2.0.safetensors" "${COMFY_DIR}/models/diffusion_models/Wan2.2_Remix_NSFW_i2v_14b_low_lighting_v2.0.safetensors"; dl "https://huggingface.co/NSFW-API/NSFW-Wan-UMT5-XXL/resolve/main/nsfw_wan_umt5-xxl_fp8_scaled.safetensors" "${COMFY_DIR}/models/clip/nsfw_wan_umt5-xxl_fp8_scaled.safetensors"; dl "https://huggingface.co/Comfy-Org/Wan_2.1_ComfyUI_repackaged/resolve/3902f61b9647e65d4de4fb5febad34ca0e4dc5c8/split_files/vae/wan_2.1_vae.safetensors" "${COMFY_DIR}/models/vae/wan_2.1_vae.safetensors"; if [ ! -f "${COMFY_DIR}/models/upscale_models/1xSkinContrast-SuperUltraCompact.pth" ]; then log "‚¨áÔ∏è Downloading: 1xSkinContrast-SuperUltraCompact.pth"; gdown --id 1-pC6_7Lrmy3p-VAh-dGzvETRBUUAQzmV -O "${COMFY_DIR}/models/upscale_models/1xSkinContrast-SuperUltraCompact.pth"; log "‚úÖ Downloaded: 1xSkinContrast-SuperUltraCompact.pth"; else log "‚úÖ Model exists: 1xSkinContrast-SuperUltraCompact.pth"; fi; if [ -n "${civitai_token:-}" ]; then dltoken "https://civitai.com/api/download/models/2312759" "${COMFY_DIR}/models/loras/boobiefixer_high.safetensors" "${civitai_token}"; dltoken "https://civitai.com/api/download/models/2312689" "${COMFY_DIR}/models/loras/boobiefixer_low.safetensors" "${civitai_token}"; dltoken "https://civitai.com/api/download/models/2284083" "${COMFY_DIR}/models/loras/penis_fixer_high.safetensors" "${civitai_token}"; dltoken "https://civitai.com/api/download/models/2284089" "${COMFY_DIR}/models/loras/penis_fixer_low.safetensors" "${civitai_token}"; dltoken "https://civitai.com/api/download/models/2073605" "${COMFY_DIR}/models/loras/nsfwsks_high.safetensors" "${civitai_token}"; dltoken "https://civitai.com/api/download/models/2083303" "${COMFY_DIR}/models/loras/nsfwsks_low.safetensors" "${civitai_token}"; dltoken "https://civitai.com/api/download/models/2012120" "${COMFY_DIR}/models/loras/female_genitals_LOW.safetensors" "${civitai_token}"; else log "‚ö†Ô∏è civitai_token not set, skipping Civitai LoRAs"; fi; touch "${BOOT_SENTINEL}"; log "üèÅ Bootstrap complete (sentinel written)"; else log "‚ö° Bootstrap already done (fast start)"; fi
cd "${COMFY_DIR}"
log "üåê Starting ComfyUI: ${COMFYUI_ARGS}"
python main.py ${COMFYUI_ARGS}
